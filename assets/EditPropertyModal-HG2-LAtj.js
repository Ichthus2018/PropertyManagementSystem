import{u as Ie,j as e,z as Ae,L as Me,e as we,q as ke,f as ze,g as Oe,s as W}from"./index-CD-AWF4T.js";import{b as t}from"./vendor-D0onPmP6.js";import{I as Ce,v as Qe}from"./ImageUploader-DWbVZMVl.js";import{I as We,F as O,a as Ge}from"./index-BHaIYkby.js";import{S as Ze}from"./Stepper-0NBI6azx.js";import"./ui-CRpVhgKF.js";import"./react-paginate-Ca9dLlTL.js";const G=n=>Ge.get(`https://isaacdarcilla.github.io/philippine-addresses/${n}.json`),Pe=async()=>{try{return(await G("region")).data.map(i=>({id:i.id,psgc_code:i.psgc_code,region_name:i.region_name,region_code:i.region_code}))}catch(n){throw console.error("Error fetching regions:",n.message),n}},Fe=async n=>{try{return(await G("province")).data.filter(a=>a.region_code===n).map(a=>({psgc_code:a.psgc_code,province_name:a.province_name,province_code:a.province_code,region_code:a.region_code}))}catch(i){throw console.error("Error fetching provinces:",i.message),i}},De=async n=>{try{return(await G("city")).data.filter(a=>a.province_code===n).map(a=>({city_name:a.city_name,city_code:a.city_code,province_code:a.province_code,region_desc:a.region_desc}))}catch(i){throw console.error("Error fetching cities:",i.message),i}},qe=async n=>{try{return(await G("barangay")).data.filter(a=>a.city_code===n).map(a=>({brgy_name:a.brgy_name,brgy_code:a.brgy_code,province_code:a.province_code,region_code:a.region_code}))}catch(i){throw console.error("Error fetching barangays:",i.message),i}},m=({label:n,children:i,description:a})=>e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1.5 text-sm font-medium text-gray-700",children:n}),i,a&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:a})]}),_="block w-full text-sm rounded-lg border-gray-300 bg-gray-50 p-2.5 text-gray-900 focus:border-orange-500 focus:ring-orange-500 disabled:cursor-not-allowed disabled:opacity-60",Q=`${_} appearance-none`,Ee=async(n,i)=>{if(!i)throw new Error("User ID is required for uploading files.");const a=[];for(const o of n)if(o.source==="new"&&o.file){const l=o.file,j=`user_${i}/${Qe()}-${l.name}`,{error:S}=await W.storage.from("property-documents").upload(j,l);if(S)throw console.error("Supabase upload error:",S),new Error(`Failed to upload ${l.name}.`);const{data:F}=W.storage.from("property-documents").getPublicUrl(j);if(!F?.publicUrl)throw new Error(`Could not get public URL for ${l.name}.`);a.push({url:F.publicUrl,path:j})}return a},R=["Property Details","Location","Documents"],ss=({isOpen:n,onClose:i,onSuccess:a,property:o})=>{const[l,j]=t.useState(1),[S,F]=t.useState(!1),[te,D]=t.useState(""),[ae,g]=t.useState(""),B=Ie(s=>s.userProfile),[Z,re]=t.useState(""),[H,ie]=t.useState(""),[q,oe]=t.useState(""),[E,ne]=t.useState(""),[le,ce]=t.useState(""),[de,ue]=t.useState(""),[pe,$]=t.useState([]),[V,w]=t.useState([]),[J,N]=t.useState([]),[K,f]=t.useState([]),[x,X]=t.useState(""),[y,I]=t.useState(""),[b,L]=t.useState(""),[Y,C]=t.useState(""),[A,me]=t.useState([]),[M,ge]=t.useState([]),[he,fe]=t.useState(""),[xe,ye]=t.useState(""),[be,ve]=t.useState([]),_e=parseFloat(q||0),je=parseFloat(E||0),P=_e-je;t.useEffect(()=>{(async()=>{try{const r=await Pe();$(r)}catch(r){console.error("Failed to load Philippine regions:",r),$([])}})()},[]),t.useEffect(()=>{(async()=>{if(x)try{const r=await Fe(x);w(r)}catch(r){console.error(`Failed to load provinces for ${x}:`,r),w([])}else w([])})()},[x]),t.useEffect(()=>{(async()=>{if(y)try{const r=await De(y);N(r)}catch(r){console.error(`Failed to load cities for ${y}:`,r),N([])}else N([])})()},[y]),t.useEffect(()=>{(async()=>{if(b)try{const r=await qe(b);f(r)}catch(r){console.error(`Failed to load barangays for ${b}:`,r),f([])}else f([])})()},[b]),t.useEffect(()=>{n&&(async()=>{if(!o)return;ve([]),D(""),g(""),j(1),re(o.property_name||""),ie(o.number_of_units||""),oe(o.overall_sqm||""),ne(o.total_sqm||""),ce(o.address_street||""),ue(o.address_zip_code||"");try{const u=await Pe();$(u);const p=u.find(h=>h.region_name===o.address_region);if(!p)return;X(p.region_code);const U=await Fe(p.region_code);w(U);const v=U.find(h=>h.province_name===o.address_province);if(!v)return;I(v.province_code);const d=await De(v.province_code);N(d);const T=d.find(h=>h.city_name===o.address_city_municipality);if(!T)return;L(T.city_code);const k=await qe(T.city_code);f(k);const z=k.find(h=>h.brgy_name===o.address_barangay);z&&C(z.brgy_code)}catch(u){console.error("Failed to populate address dropdowns:",u),$([]),w([]),N([]),f([]),X(""),I(""),L(""),C("")}const r=u=>!u||!Array.isArray(u.files)?[]:u.files.map(p=>({...p,id:p.path,preview:p.url,source:"existing"}));me(r(o.business_licenses)),ge(r(o.certificates_of_registration)),fe(o.business_licenses?.description||""),ye(o.certificates_of_registration?.description||"")})()},[o,n]);const ee=()=>{i()},Le=()=>{g("");let s=!0;l===1&&(Z.trim()||(g("Property Name is a required field."),s=!1),P<0&&(g("Total Unit SQM cannot be greater than the Overall Property SQM."),s=!1)),l===2&&(x?y?b?Y||(g("Barangay is a required field."),s=!1):(g("City / Municipality is a required field."),s=!1):(g("Province is a required field."),s=!1):(g("Region is a required field."),s=!1)),s&&l<R.length&&j(l+1)},Ue=()=>{g(""),l>1&&j(l-1)},Te=async s=>{if(s.preventDefault(),l===R.length){if(P<0){D("Cannot save: Total Unit SQM exceeds Overall Property SQM.");return}if(!o||!B?.id){D("Cannot update property. Missing required data.");return}F(!0),D(""),g("");try{if(be.length>0){const{error:c}=await W.storage.from("property-documents").remove(be);c&&console.error("Error deleting old files:",c)}const r=await Ee(A,B.id),u=await Ee(M,B.id),p=[...A.filter(c=>c.source==="existing").map(({url:c,path:se})=>({url:c,path:se})),...r],U=[...M.filter(c=>c.source==="existing").map(({url:c,path:se})=>({url:c,path:se})),...u],v={files:p,description:he.trim()},d={files:U,description:xe.trim()},T=pe.find(c=>c.region_code===x)?.region_name,k=V.find(c=>c.province_code===y)?.province_name,z=J.find(c=>c.city_code===b)?.city_name,h=K.find(c=>c.brgy_code===Y)?.brgy_name,$e={last_edited_by:B.id,property_name:Z.trim(),number_of_units:H?parseInt(H,10):null,total_sqm:E?parseFloat(E):null,overall_sqm:q?parseFloat(q):null,address_country:"Philippines",address_country_iso:"PH",address_street:le.trim(),address_zip_code:de.trim()||null,address_region:T||null,address_province:k||null,address_city_municipality:z||null,address_barangay:h||null,business_licenses:v,certificates_of_registration:d},{error:Se}=await W.from("properties").update($e).eq("id",o.id);if(Se)throw Se;a(),ee()}catch(r){console.error("Error updating property:",r),D(`Failed to update property: ${r.message}`)}finally{F(!1)}}},Ne=(s,r)=>u=>{const p=new Set(u.map(d=>d.id)),v=s.filter(d=>!p.has(d.id)).filter(d=>d.source==="existing").map(d=>d.path);v.length>0&&ve(d=>[...new Set([...d,...v])]),r(u)},Re=Ne(A,me),Be=Ne(M,ge);return e.jsx(Ae,{appear:!0,show:n,as:t.Fragment,children:e.jsxs(Me,{as:"div",className:"relative z-50",onClose:ee,children:[e.jsx(we,{as:t.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm"})}),e.jsx("div",{className:"fixed inset-0 overflow-y-auto",children:e.jsx("div",{className:"flex min-h-full items-center justify-center p-2 sm:p-4",children:e.jsx(we,{as:t.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:e.jsxs(ke,{className:"w-full max-w-7xl transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ze,{as:"h3",className:"text-2xl font-bold leading-6 text-gray-900",children:"Edit Property"}),e.jsx("button",{type:"button",onClick:ee,className:"text-gray-400 hover:text-gray-600 transition-colors","aria-label":"Close",children:e.jsx(We,{className:"h-6 w-6"})})]}),e.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:['Update the details for "',o?.property_name||"your property",'".']}),e.jsx(Ze,{currentStep:l,steps:R}),e.jsxs("form",{onSubmit:Te,className:"mt-6",children:[S&&e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(Oe,{})}),e.jsxs("div",{className:"min-h-[350px]",children:[l===1&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Property Details"}),e.jsx("div",{className:"md:col-span-3",children:e.jsx(m,{label:"Property Name*",children:e.jsx("input",{type:"text",placeholder:"e.g., The Grand Residences",value:Z,onChange:s=>re(s.target.value),className:_,required:!0})})}),e.jsx("div",{children:e.jsx(m,{label:"Overall Property SQM",description:"The total physical size of the property, including common areas like hallways.",children:e.jsx("input",{type:"number",step:"0.01",placeholder:"e.g., 1500",value:q,onChange:s=>oe(s.target.value),className:_})})}),e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Units Details"}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsx("div",{children:e.jsx(m,{label:"Number of Units",children:e.jsx("input",{type:"number",placeholder:"e.g., 50",value:H,onChange:s=>ie(s.target.value),className:_,min:"0"})})}),e.jsx("div",{children:e.jsx(m,{label:"Total Unit SQM",description:"The sum of the area of all rentable units. This will be used for unit allocation.",children:e.jsx("input",{type:"number",step:"0.01",placeholder:"e.g., 1200.50",value:E,onChange:s=>ne(s.target.value),className:_})})})]}),q>0&&E>0&&e.jsxs("div",{className:`mt-6 p-4 rounded-lg text-sm ${P<0?"bg-red-50 text-red-800 border-red-200":"bg-gray-100 text-gray-800 border-gray-200"} border transition-colors`,children:[e.jsx("h5",{className:"font-bold mb-2",children:"Area Calculation"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{children:["Overall Property Area:"," ",e.jsxs("span",{className:"font-semibold",children:[_e.toLocaleString()," sqm"]})]}),e.jsxs("p",{children:["- Total Unit Area:"," ",e.jsxs("span",{className:"font-semibold",children:[je.toLocaleString()," sqm"]})]}),e.jsx("hr",{className:"my-1"}),e.jsxs("p",{className:`font-bold ${P<0?"text-red-600":""}`,children:["= Common/Unused Area:"," ",e.jsxs("span",{children:[P.toLocaleString()," sqm"]})]})]}),P<0&&e.jsx("p",{className:"mt-2 font-semibold",children:"Warning: The total unit area cannot be larger than the overall property area."})]})]}),l===2&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Location"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(m,{label:"Country*",children:e.jsx("input",{type:"text",value:"Philippines",className:_,disabled:!0,readOnly:!0})})}),e.jsx("div",{className:"relative",children:e.jsxs(m,{label:"Region*",children:[e.jsxs("select",{value:x,onChange:s=>{X(s.target.value),I(""),L(""),C(""),w([]),N([]),f([])},className:Q,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a region..."}),pe.map(s=>e.jsx("option",{value:s.region_code,children:s.region_name},s.region_code))]}),e.jsx(O,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(m,{label:"Province*",children:[e.jsxs("select",{value:y,onChange:s=>{I(s.target.value),L(""),C(""),N([]),f([])},className:Q,disabled:!x||V.length===0,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a province..."}),V.map(s=>e.jsx("option",{value:s.province_code,children:s.province_name},s.province_code))]}),e.jsx(O,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(m,{label:"City / Municipality*",children:[e.jsxs("select",{value:b,onChange:s=>{L(s.target.value),C(""),f([])},className:Q,disabled:!y||J.length===0,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a city/municipality..."}),J.map(s=>e.jsx("option",{value:s.city_code,children:s.city_name},s.city_code))]}),e.jsx(O,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(m,{label:"Barangay*",children:[e.jsxs("select",{value:Y,onChange:s=>{C(s.target.value)},className:Q,disabled:!b||K.length===0,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a barangay..."}),K.map(s=>e.jsx("option",{value:s.brgy_code,children:s.brgy_name},s.brgy_code))]}),e.jsx(O,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx(m,{label:"Street Address",children:e.jsx("input",{type:"text",placeholder:"e.g., 123 Oak Avenue",value:le,onChange:s=>ce(s.target.value),className:_})}),e.jsx(m,{label:"Zip / Postal Code",children:e.jsx("input",{type:"text",placeholder:"e.g., 1605",value:de,onChange:s=>ue(s.target.value),className:_})})]})]}),l===3&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Supporting Documents"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Add, remove, or update supporting documents for this property."}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ce,{label:"Business License(s)",files:A,setFiles:Re,description:he,setDescription:fe}),e.jsx(Ce,{label:"Certificate(s) of Registration",files:M,setFiles:Be,description:xe,setDescription:ye})]})]})]}),(te||ae)&&e.jsx("p",{className:"mt-4 text-sm font-medium text-red-600 bg-red-50 p-3 rounded-lg",children:te||ae}),e.jsxs("div",{className:"flex justify-center gap-4 pt-6 mt-8 sm:justify-end sm:gap-3",children:[l>1&&e.jsx("button",{type:"button",onClick:Ue,className:"flex-1 rounded-full border border-gray-300 bg-white px-8 py-3 text-sm font-medium text-gray-800 transition-colors hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:"Previous"}),l<R.length&&e.jsx("button",{type:"button",onClick:Le,className:"flex-1 rounded-full bg-orange-600 px-8 py-3 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-orange-800 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:"Next"}),l===R.length&&e.jsx("button",{type:"submit",disabled:S,className:"flex-1 rounded-full bg-teal-600 px-8 py-3 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-teal-800 disabled:cursor-not-allowed disabled:bg-gray-300 disabled:text-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:S?"Saving Changes...":"Save Changes"})]})]})]})})})})]})})};export{ss as default};
