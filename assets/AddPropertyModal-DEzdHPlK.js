import{u as z,j as e,z as Q,L as V,e as w,q as W,f as Z,g as J,s as T}from"./index-CD-AWF4T.js";import{b as y}from"./vendor-D0onPmP6.js";import{I,v as K}from"./ImageUploader-DWbVZMVl.js";import{I as X,F as b,a as ee}from"./index-BHaIYkby.js";import{S as ae}from"./Stepper-0NBI6azx.js";import"./ui-CRpVhgKF.js";import"./react-paginate-Ca9dLlTL.js";const E=s=>ee.get(`https://isaacdarcilla.github.io/philippine-addresses/${s}.json`),se=async()=>{try{return(await E("region")).data.map(r=>({id:r.id,psgc_code:r.psgc_code,region_name:r.region_name,region_code:r.region_code}))}catch(s){throw console.error("Error fetching regions:",s.message),s}},re=async s=>{try{return(await E("province")).data.filter(i=>i.region_code===s).map(i=>({psgc_code:i.psgc_code,province_name:i.province_name,province_code:i.province_code,region_code:i.region_code}))}catch(r){throw console.error("Error fetching provinces:",r.message),r}},te=async s=>{try{return(await E("city")).data.filter(i=>i.province_code===s).map(i=>({city_name:i.city_name,city_code:i.city_code,province_code:i.province_code,region_desc:i.region_desc}))}catch(r){throw console.error("Error fetching cities:",r.message),r}},oe=async s=>{try{return(await E("barangay")).data.filter(i=>i.city_code===s).map(i=>({brgy_name:i.brgy_name,brgy_code:i.brgy_code,province_code:i.province_code,region_code:i.region_code}))}catch(r){throw console.error("Error fetching barangays:",r.message),r}},c=({label:s,children:r,description:i})=>e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1.5 text-sm font-medium text-gray-700",children:s}),r,i&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:i})]}),m="block w-full text-sm rounded-lg border-gray-300 bg-gray-50 p-2.5 text-gray-900 focus:border-orange-500 focus:ring-orange-500 disabled:cursor-not-allowed disabled:opacity-60",v=`${m} appearance-none`,U=async(s,r)=>{if(!r)throw new Error("User ID is required for uploading files.");const i=s.filter(h=>h.source==="new"&&h.file).map(async h=>{const o=h.file,d=`user_${r}/${K()}-${o.name}`,{error:l}=await T.storage.from("property-documents").upload(d,o);if(l)throw console.error("Supabase upload error:",l),new Error(`Failed to upload ${o.name}.`);const{data:t}=T.storage.from("property-documents").getPublicUrl(d);if(!t?.publicUrl)throw new Error(`Could not get public URL for ${o.name}.`);return{url:t.publicUrl,path:d}});return Promise.all(i)},x=["Property Details","Location","Documents"],p={propertyDetails:{propertyName:"",numberOfUnits:"",overallSqm:"",totalUnitSqm:""},location:{street:"",zipCode:"",regions:{status:"idle",data:[],error:null},provinces:{status:"idle",data:[],error:null},cities:{status:"idle",data:[],error:null},barangays:{status:"idle",data:[],error:null},selectedRegionCode:"",selectedProvinceCode:"",selectedCityCode:"",selectedBarangayCode:""},documents:{businessLicenses:[],certificates:[],licenseDescription:"",certificateDescription:""},ui:{currentStep:1,isSubmitting:!1,error:"",stepError:""}};function ie(s,r){switch(r.type){case"SET_PROPERTY_DETAIL":return{...s,propertyDetails:{...s.propertyDetails,[r.field]:r.payload}};case"SET_REGION":return{...s,location:{...s.location,selectedRegionCode:r.payload,selectedProvinceCode:"",selectedCityCode:"",selectedBarangayCode:"",provinces:{...p.location.provinces,status:"loading"},cities:p.location.cities,barangays:p.location.barangays}};case"SET_PROVINCE":return{...s,location:{...s.location,selectedProvinceCode:r.payload,selectedCityCode:"",selectedBarangayCode:"",cities:{...p.location.cities,status:"loading"},barangays:p.location.barangays}};case"SET_CITY":return{...s,location:{...s.location,selectedCityCode:r.payload,selectedBarangayCode:"",barangays:{...p.location.barangays,status:"loading"}}};case"SET_BARANGAY":return{...s,location:{...s.location,selectedBarangayCode:r.payload}};case"SET_LOCATION_FIELD":return{...s,location:{...s.location,[r.field]:r.payload}};case"FETCH_REGIONS_SUCCESS":return{...s,location:{...s.location,regions:{status:"success",data:r.payload}}};case"FETCH_PROVINCES_SUCCESS":return{...s,location:{...s.location,provinces:{status:"success",data:r.payload}}};case"FETCH_CITIES_SUCCESS":return{...s,location:{...s.location,cities:{status:"success",data:r.payload}}};case"FETCH_BARANGAYS_SUCCESS":return{...s,location:{...s.location,barangays:{status:"success",data:r.payload}}};case"FETCH_LOCATION_ERROR":return console.error(`Error fetching ${r.level}:`,r.error),{...s,location:{...s.location,[r.level]:{status:"error",data:[],error:r.error}}};case"SET_DOCUMENTS":return{...s,documents:{...s.documents,[r.field]:r.payload}};case"SET_STEP":return{...s,ui:{...s.ui,currentStep:r.payload,stepError:""}};case"SET_SUBMITTING":return{...s,ui:{...s.ui,isSubmitting:r.payload}};case"SET_ERROR":return{...s,ui:{...s.ui,error:r.payload,stepError:""}};case"SET_STEP_ERROR":return{...s,ui:{...s.ui,stepError:r.payload,error:""}};case"RESET_FORM":return{...p,location:{...p.location,regions:s.location.regions}};default:throw new Error(`Unhandled action type: ${r.type}`)}}const me=({isOpen:s,onClose:r,onSuccess:i})=>{const[h,o]=y.useReducer(ie,p),d=z(a=>a.userProfile),{propertyDetails:l,location:t,documents:u,ui:F}=h,{currentStep:n,isSubmitting:S,error:N,stepError:j}=F,R=parseFloat(l.overallSqm||0),O=parseFloat(l.totalUnitSqm||0),f=R-O;y.useEffect(()=>{se().then(a=>o({type:"FETCH_REGIONS_SUCCESS",payload:a})).catch(a=>o({type:"FETCH_LOCATION_ERROR",level:"regions",error:a.message}))},[]),y.useEffect(()=>{t.selectedRegionCode&&re(t.selectedRegionCode).then(a=>o({type:"FETCH_PROVINCES_SUCCESS",payload:a})).catch(a=>o({type:"FETCH_LOCATION_ERROR",level:"provinces",error:a.message}))},[t.selectedRegionCode]),y.useEffect(()=>{t.selectedProvinceCode&&te(t.selectedProvinceCode).then(a=>o({type:"FETCH_CITIES_SUCCESS",payload:a})).catch(a=>o({type:"FETCH_LOCATION_ERROR",level:"cities",error:a.message}))},[t.selectedProvinceCode]),y.useEffect(()=>{t.selectedCityCode&&oe(t.selectedCityCode).then(a=>o({type:"FETCH_BARANGAYS_SUCCESS",payload:a})).catch(a=>o({type:"FETCH_LOCATION_ERROR",level:"barangays",error:a.message}))},[t.selectedCityCode]);const C=()=>{o({type:"RESET_FORM"}),r()},D=()=>{let a=!0;n===1&&(l.propertyName.trim()||(o({type:"SET_STEP_ERROR",payload:"Property Name is a required field."}),a=!1),f<0&&(o({type:"SET_STEP_ERROR",payload:"Total Unit SQM cannot be greater than the Overall Property SQM."}),a=!1)),n===2&&(t.selectedRegionCode?t.selectedProvinceCode?t.selectedCityCode?t.selectedBarangayCode||(o({type:"SET_STEP_ERROR",payload:"Barangay is a required field."}),a=!1):(o({type:"SET_STEP_ERROR",payload:"City / Municipality is a required field."}),a=!1):(o({type:"SET_STEP_ERROR",payload:"Province is a required field."}),a=!1):(o({type:"SET_STEP_ERROR",payload:"Region is a required field."}),a=!1)),a&&n<x.length&&o({type:"SET_STEP",payload:n+1})},A=()=>{n>1&&o({type:"SET_STEP",payload:n-1})},q=async a=>{if(a.preventDefault(),n===x.length){if(f<0){o({type:"SET_ERROR",payload:"Cannot save: Total Unit SQM exceeds Overall Property SQM."});return}if(!d?.id){o({type:"SET_ERROR",payload:"You must be logged in to add a property."});return}o({type:"SET_SUBMITTING",payload:!0}),o({type:"SET_ERROR",payload:""});try{const[_,L]=await Promise.all([U(u.businessLicenses,d.id),U(u.certificates,d.id)]),B={files:_,description:u.licenseDescription.trim()},M={files:L,description:u.certificateDescription.trim()},H=t.regions.data.find(g=>g.region_code===t.selectedRegionCode)?.region_name,G=t.provinces.data.find(g=>g.province_code===t.selectedProvinceCode)?.province_name,$=t.cities.data.find(g=>g.city_code===t.selectedCityCode)?.city_name,Y=t.barangays.data.find(g=>g.brgy_code===t.selectedBarangayCode)?.brgy_name,k={created_by:d.id,last_edited_by:d.id,property_name:l.propertyName.trim(),number_of_units:l.numberOfUnits?parseInt(l.numberOfUnits,10):null,total_sqm:l.totalUnitSqm?parseFloat(l.totalUnitSqm):null,overall_sqm:l.overallSqm?parseFloat(l.overallSqm):null,address_country:"Philippines",address_country_iso:"PH",address_street:t.street.trim(),address_zip_code:t.zipCode.trim()||null,address_region:H||null,address_province:G||null,address_city_municipality:$||null,address_barangay:Y||null,business_licenses:B,certificates_of_registration:M},{error:P}=await T.from("properties").insert([k]);if(P)throw P;i(),C()}catch(_){console.error("Error adding property:",_),o({type:"SET_ERROR",payload:`Failed to add property: ${_.message}`})}finally{o({type:"SET_SUBMITTING",payload:!1})}}};return e.jsx(Q,{appear:!0,show:s,as:y.Fragment,children:e.jsxs(V,{as:"div",className:"relative z-50",onClose:C,children:[e.jsx(w,{as:y.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm"})}),e.jsx("div",{className:"fixed inset-0 overflow-y-auto",children:e.jsx("div",{className:"flex min-h-full items-center justify-center p-2 sm:p-4",children:e.jsx(w,{as:y.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:e.jsxs(W,{className:"w-full max-w-7xl transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Z,{as:"h3",className:"text-2xl font-bold leading-6 text-gray-900",children:"Add New Property"}),e.jsx("button",{type:"button",onClick:C,className:"text-gray-400 hover:text-gray-600 transition-colors","aria-label":"Close",children:e.jsx(X,{className:"h-6 w-6"})})]}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Fill in the details below to register your property."}),e.jsx(ae,{currentStep:n,steps:x}),e.jsxs("form",{onSubmit:q,className:"mt-6",children:[S&&e.jsx("div",{className:"flex justify-center py-20",children:e.jsx(J,{})}),e.jsxs("div",{className:"min-h-[350px]",children:[n===1&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Property Details"}),e.jsx("div",{className:"md:col-span-3",children:e.jsx(c,{label:"Property Name*",children:e.jsx("input",{type:"text",placeholder:"e.g., The Grand Residences",value:l.propertyName,onChange:a=>o({type:"SET_PROPERTY_DETAIL",field:"propertyName",payload:a.target.value}),className:m,required:!0})})}),e.jsx("div",{children:e.jsx(c,{label:"Overall Property SQM",description:"The total physical size of the property, including common areas like hallways.",children:e.jsx("input",{type:"number",step:"0.01",placeholder:"e.g., 1500",value:l.overallSqm,onChange:a=>o({type:"SET_PROPERTY_DETAIL",field:"overallSqm",payload:a.target.value}),className:m})})}),e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Units Details"}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsx("div",{children:e.jsx(c,{label:"Number of Units",children:e.jsx("input",{type:"number",placeholder:"e.g., 50",value:l.numberOfUnits,onChange:a=>o({type:"SET_PROPERTY_DETAIL",field:"numberOfUnits",payload:a.target.value}),className:m,min:"0"})})}),e.jsx("div",{children:e.jsx(c,{label:"Total Unit SQM",description:"The sum of the area of all rentable units. This will be used for unit allocation.",children:e.jsx("input",{type:"number",step:"0.01",placeholder:"e.g., 1200.50",value:l.totalUnitSqm,onChange:a=>o({type:"SET_PROPERTY_DETAIL",field:"totalUnitSqm",payload:a.target.value}),className:m})})})]}),l.overallSqm>0&&l.totalUnitSqm>0&&e.jsxs("div",{className:`mt-6 p-4 rounded-lg text-sm ${f<0?"bg-red-50 text-red-800 border-red-200":"bg-gray-100 text-gray-800 border-gray-200"} border transition-colors`,children:[e.jsx("h5",{className:"font-bold mb-2",children:"Area Calculation"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{children:["Overall Property Area:"," ",e.jsxs("span",{className:"font-semibold",children:[R.toLocaleString()," sqm"]})]}),e.jsxs("p",{children:["- Total Unit Area:"," ",e.jsxs("span",{className:"font-semibold",children:[O.toLocaleString()," sqm"]})]}),e.jsx("hr",{className:"my-1"}),e.jsxs("p",{className:`font-bold ${f<0?"text-red-600":""}`,children:["= Common/Unused Area:"," ",e.jsxs("span",{children:[f.toLocaleString()," sqm"]})]})]}),f<0&&e.jsx("p",{className:"mt-2 font-semibold",children:"Warning: The total unit area cannot be larger than the overall property area."})]})]}),n===2&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Location"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(c,{label:"Country*",children:e.jsx("input",{type:"text",value:"Philippines",className:m,disabled:!0,readOnly:!0})})}),e.jsx("div",{className:"relative",children:e.jsxs(c,{label:"Region*",children:[e.jsxs("select",{value:t.selectedRegionCode,onChange:a=>o({type:"SET_REGION",payload:a.target.value}),className:v,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:t.regions.status==="loading"?"Loading regions...":"Select a region..."}),t.regions.data.map(a=>e.jsx("option",{value:a.region_code,children:a.region_name},a.region_code))]}),e.jsx(b,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(c,{label:"Province*",children:[e.jsxs("select",{value:t.selectedProvinceCode,onChange:a=>o({type:"SET_PROVINCE",payload:a.target.value}),className:v,disabled:!t.selectedRegionCode||t.provinces.status!=="success",required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:t.provinces.status==="loading"?"Loading provinces...":"Select a province..."}),t.provinces.data.map(a=>e.jsx("option",{value:a.province_code,children:a.province_name},a.province_code))]}),e.jsx(b,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(c,{label:"City / Municipality*",children:[e.jsxs("select",{value:t.selectedCityCode,onChange:a=>o({type:"SET_CITY",payload:a.target.value}),className:v,disabled:!t.selectedProvinceCode||t.cities.status!=="success",required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:t.cities.status==="loading"?"Loading cities...":"Select a city/municipality..."}),t.cities.data.map(a=>e.jsx("option",{value:a.city_code,children:a.city_name},a.city_code))]}),e.jsx(b,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(c,{label:"Barangay*",children:[e.jsxs("select",{value:t.selectedBarangayCode,onChange:a=>o({type:"SET_BARANGAY",payload:a.target.value}),className:v,disabled:!t.selectedCityCode||t.barangays.status!=="success",required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:t.barangays.status==="loading"?"Loading barangays...":"Select a barangay..."}),t.barangays.data.map(a=>e.jsx("option",{value:a.brgy_code,children:a.brgy_name},a.brgy_code))]}),e.jsx(b,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx(c,{label:"Street Address",children:e.jsx("input",{type:"text",placeholder:"e.g., 123 Oak Avenue",value:t.street,onChange:a=>o({type:"SET_LOCATION_FIELD",field:"street",payload:a.target.value}),className:m})}),e.jsx(c,{label:"Zip / Postal Code",children:e.jsx("input",{type:"text",placeholder:"e.g., 1605",value:t.zipCode,onChange:a=>o({type:"SET_LOCATION_FIELD",field:"zipCode",payload:a.target.value}),className:m})})]})]}),n===3&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Supporting Documents"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Uploading documents is optional but recommended for faster verification."}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(I,{label:"Business License(s)",files:u.businessLicenses,setFiles:a=>o({type:"SET_DOCUMENTS",field:"businessLicenses",payload:a}),description:u.licenseDescription,setDescription:a=>o({type:"SET_DOCUMENTS",field:"licenseDescription",payload:a})}),e.jsx(I,{label:"Certificate(s) of Registration",files:u.certificates,setFiles:a=>o({type:"SET_DOCUMENTS",field:"certificates",payload:a}),description:u.certificateDescription,setDescription:a=>o({type:"SET_DOCUMENTS",field:"certificateDescription",payload:a})})]})]})]}),(N||j)&&e.jsx("p",{className:"mt-4 text-sm font-medium text-red-600 bg-red-50 p-3 rounded-lg",children:N||j}),e.jsxs("div",{className:"flex justify-center gap-4 pt-6 mt-8 sm:justify-end sm:gap-3",children:[n>1&&e.jsx("button",{type:"button",onClick:A,className:"flex-1 rounded-full border border-gray-300 bg-white px-8 py-3 text-sm font-medium text-gray-800 transition-colors hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:"Previous"}),n<x.length&&e.jsx("button",{type:"button",onClick:D,className:"flex-1 rounded-full bg-orange-600 px-8 py-3 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-orange-800 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:"Next"}),n===x.length&&e.jsx("button",{type:"submit",disabled:S,className:"flex-1 rounded-full bg-teal-600 px-8 py-3 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-teal-800 disabled:cursor-not-allowed disabled:bg-gray-300 disabled:text-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:S?"Adding Property...":"Add Property"})]})]})]})})})})]})})};export{me as default};
