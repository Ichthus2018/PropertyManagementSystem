import{u as Be,j as e,z as Ae,L as Oe,e as Ce,q as ke,f as Me,s as Q}from"./index-ChuUIRBG.js";import{b as i}from"./vendor-C5zIUBfc.js";import{I as Fe,v as ze}from"./ImageUploader-piXC7qzV.js";import{I as Qe,F as M,a as We}from"./index-DOEnYH1p.js";import{S as Ge}from"./Stepper-B5s6UTpD.js";import"./ui-DPhHsU_z.js";import"./react-paginate-dLrqzcou.js";const W=r=>We.get(`https://isaacdarcilla.github.io/philippine-addresses/${r}.json`),Pe=async()=>{try{return(await W("region")).data.map(o=>({id:o.id,psgc_code:o.psgc_code,region_name:o.region_name,region_code:o.region_code}))}catch(r){throw console.error("Error fetching regions:",r.message),r}},De=async r=>{try{return(await W("province")).data.filter(t=>t.region_code===r).map(t=>({psgc_code:t.psgc_code,province_name:t.province_name,province_code:t.province_code,region_code:t.region_code}))}catch(o){throw console.error("Error fetching provinces:",o.message),o}},Le=async r=>{try{return(await W("city")).data.filter(t=>t.province_code===r).map(t=>({city_name:t.city_name,city_code:t.city_code,province_code:t.province_code,region_desc:t.region_desc}))}catch(o){throw console.error("Error fetching cities:",o.message),o}},Ue=async r=>{try{return(await W("barangay")).data.filter(t=>t.city_code===r).map(t=>({brgy_name:t.brgy_name,brgy_code:t.brgy_code,province_code:t.province_code,region_code:t.region_code}))}catch(o){throw console.error("Error fetching barangays:",o.message),o}},p=({label:r,children:o,description:t})=>e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1.5 text-sm font-medium text-gray-700",children:r}),o,t&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:t})]}),j="block w-full text-sm rounded-lg border-gray-300 bg-gray-50 p-2.5 text-gray-900 focus:border-orange-500 focus:ring-orange-500 disabled:cursor-not-allowed disabled:opacity-60",z=`${j} appearance-none`,Ke=(r,o)=>{const t=r.lastIndexOf(".");return`${t===-1?r:r.substring(0,t)}.${o}`},Ve=(r,o={quality:.8})=>new Promise(t=>{const a=document.createElement("canvas");if(typeof a.toDataURL!="function"||a.toDataURL("image/avif").indexOf("data:image/avif")<0){console.warn("AVIF conversion not supported by this browser. Uploading original file."),t(r);return}const n=URL.createObjectURL(r),d=new Image;d.onload=()=>{a.width=d.width,a.height=d.height,a.getContext("2d").drawImage(d,0,0),a.toBlob(h=>{if(URL.revokeObjectURL(n),h&&h.type==="image/avif"){const S=Ke(r.name,"avif"),f=new File([h],S,{type:"image/avif"});console.log(`Converted ${r.name} (${(r.size/1024).toFixed(2)} KB) to ${f.name} (${(f.size/1024).toFixed(2)} KB)`),t(f)}else t(r)},"image/avif",o.quality)},d.onerror=()=>{URL.revokeObjectURL(n),console.error("Could not load image for conversion. Uploading original file."),t(r)},d.src=n}),qe=async(r,o)=>{if(!o)throw new Error("User ID is required for uploading files.");const t=[];for(const a of r)if(a.source==="new"&&a.file){let n=a.file;if(a.file.type.startsWith("image/"))try{n=await Ve(a.file)}catch(S){console.error("Image conversion failed, uploading original:",S),n=a.file}const d=`user_${o}/${ze()}-${n.name}`,{error:N}=await Q.storage.from("property-documents").upload(d,n);if(N)throw console.error("Supabase upload error:",N),new Error(`Failed to upload ${n.name}.`);const{data:h}=Q.storage.from("property-documents").getPublicUrl(d);if(!h?.publicUrl)throw new Error(`Could not get public URL for ${n.name}.`);t.push({url:h.publicUrl,path:d})}return t},R=["Property Details","Location","Documents"],ts=({isOpen:r,onClose:o,onSuccess:t,property:a})=>{const[n,d]=i.useState(1),[N,h]=i.useState(!1),[S,f]=i.useState(""),[se,g]=i.useState(""),T=Be(s=>s.userProfile),[G,te]=i.useState(""),[K,ae]=i.useState(""),[D,re]=i.useState(""),[L,ie]=i.useState(""),[oe,ne]=i.useState(""),[le,ce]=i.useState(""),[de,V]=i.useState([]),[me,$]=i.useState([]),[ue,I]=i.useState([]),[pe,B]=i.useState([]),[v,ge]=i.useState(""),[b,Z]=i.useState(""),[_,H]=i.useState(""),[J,X]=i.useState(""),[A,he]=i.useState([]),[O,fe]=i.useState([]),[xe,ye]=i.useState(""),[ve,be]=i.useState(""),[_e,je]=i.useState([]),Ne=parseFloat(D||0),Se=parseFloat(L||0),w=Ne-Se;i.useEffect(()=>{(async()=>{try{const l=await Pe();V(l)}catch(l){console.error("Failed to load Philippine regions:",l),V([])}})()},[]),i.useEffect(()=>{$([]),Z(""),(async()=>{if(v)try{const l=await De(v);$(l)}catch(l){console.error(`Failed to load provinces for ${v}:`,l),$([])}})()},[v]),i.useEffect(()=>{I([]),H(""),(async()=>{if(b)try{const l=await Le(b);I(l)}catch(l){console.error(`Failed to load cities for ${b}:`,l),I([])}})()},[b]),i.useEffect(()=>{B([]),X(""),(async()=>{if(_)try{const l=await Ue(_);B(l)}catch(l){console.error(`Failed to load barangays for ${_}:`,l),B([])}})()},[_]),i.useEffect(()=>{r&&(async()=>{if(!a)return;te(a.property_name||""),ae(a.number_of_units||""),re(a.overall_sqm||""),ie(a.total_sqm||""),ne(a.address_street||""),ce(a.address_zip_code||"");try{const m=await Pe();V(m);const x=a.address_region,C=m.find(y=>y.region_name===x);if(C){ge(C.region_code);const y=await De(C.region_code);$(y);const u=a.address_province,U=y.find(F=>F.province_name===u);if(U){Z(U.province_code);const F=await Le(U.province_code);I(F);const ee=a.address_city_municipality,q=F.find(P=>P.city_name===ee);if(q){H(q.city_code);const P=await Ue(q.city_code);B(P);const k=a.address_barangay,c=P.find(E=>E.brgy_name===k);c&&X(c.brgy_code)}}}}catch(m){console.error("Failed to populate address data:",m)}const l=m=>!m||!Array.isArray(m.files)?[]:m.files.map(x=>({...x,id:x.path,preview:x.url,source:"existing"}));he(l(a.business_licenses)),fe(l(a.certificates_of_registration)),ye(a.business_licenses?.description||""),be(a.certificates_of_registration?.description||""),je([]),f(""),g(""),d(1)})()},[a,r]);const Y=()=>{o()},Ee=()=>{g("");let s=!0;n===1&&(G.trim()||(g("Property Name is a required field."),s=!1),w<0&&(g("Total Unit SQM cannot be greater than the Overall Property SQM."),s=!1)),n===2&&(v?b?_?J||(g("Barangay is a required field."),s=!1):(g("City / Municipality is a required field."),s=!1):(g("Province is a required field."),s=!1):(g("Region is a required field."),s=!1)),s&&n<R.length&&d(n+1)},Re=()=>{g(""),n>1&&d(n-1)},Te=async s=>{if(s.preventDefault(),n===R.length){if(w<0){f("Cannot save: Total Unit SQM exceeds Overall Property SQM.");return}if(!a||!T?.id){f("Cannot update property. Missing required data.");return}h(!0),f(""),g("");try{if(_e.length>0){const{error:c}=await Q.storage.from("property-documents").remove(_e);c&&console.error("Error deleting old files:",c)}const l=await qe(A,T.id),m=await qe(O,T.id),x=[...A.filter(c=>c.source==="existing").map(({url:c,path:E})=>({url:c,path:E})),...l],C=[...O.filter(c=>c.source==="existing").map(({url:c,path:E})=>({url:c,path:E})),...m],y={files:x,description:xe.trim()},u={files:C,description:ve.trim()},U=de.find(c=>c.region_code===v)?.region_name,F=me.find(c=>c.province_code===b)?.province_name,ee=ue.find(c=>c.city_code===_)?.city_name,q=pe.find(c=>c.brgy_code===J)?.brgy_name,P={last_edited_by:T.id,property_name:G.trim(),number_of_units:K?parseInt(K,10):null,total_sqm:L?parseFloat(L):null,overall_sqm:D?parseFloat(D):null,address_country:"Philippines",address_country_iso:"PH",address_street:oe.trim(),address_zip_code:le.trim()||null,address_region:U||null,address_province:F||null,address_city_municipality:ee||null,address_barangay:q||null,address_state:null,address_state_iso:null,business_licenses:y,certificates_of_registration:u},{error:k}=await Q.from("properties").update(P).eq("id",a.id);if(k)throw k;t(),Y()}catch(l){console.error("Error updating property:",l),f(`Failed to update property: ${l.message}`)}finally{h(!1)}}},we=(s,l)=>m=>{const x=new Set(m.map(u=>u.id)),y=s.filter(u=>!x.has(u.id)).filter(u=>u.source==="existing").map(u=>u.path);y.length>0&&je(u=>[...new Set([...u,...y])]),l(m)},$e=we(A,he),Ie=we(O,fe);return e.jsx(Ae,{appear:!0,show:r,as:i.Fragment,children:e.jsxs(Oe,{as:"div",className:"relative z-50",onClose:Y,children:[e.jsx(Ce,{as:i.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm"})}),e.jsx("div",{className:"fixed inset-0 overflow-y-auto",children:e.jsx("div",{className:"flex min-h-full items-center justify-center p-2 sm:p-4",children:e.jsx(Ce,{as:i.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:e.jsxs(ke,{className:"w-full max-w-7xl transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Me,{as:"h3",className:"text-2xl font-bold leading-6 text-gray-900",children:"Edit Property"}),e.jsx("button",{type:"button",onClick:Y,className:"text-gray-400 hover:text-gray-600 transition-colors","aria-label":"Close",children:e.jsx(Qe,{className:"h-6 w-6"})})]}),e.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:['Update the details for "',a?.property_name||"your property",'".']}),e.jsx(Ge,{currentStep:n,steps:R}),e.jsxs("form",{onSubmit:Te,className:"mt-6",children:[e.jsxs("div",{className:"min-h-[350px]",children:[n===1&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Property Details"}),e.jsx("div",{className:"md:col-span-3",children:e.jsx(p,{label:"Property Name*",children:e.jsx("input",{type:"text",placeholder:"e.g., The Grand Residences",value:G,onChange:s=>te(s.target.value),className:j,required:!0})})}),e.jsx("div",{children:e.jsx(p,{label:"Overall Property SQM",description:"The total physical size of the property, including common areas like hallways.",children:e.jsx("input",{type:"number",step:"0.01",placeholder:"e.g., 1500",value:D,onChange:s=>re(s.target.value),className:j})})}),e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Units Details"}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsx("div",{children:e.jsx(p,{label:"Number of Units",children:e.jsx("input",{type:"number",placeholder:"e.g., 50",value:K,onChange:s=>ae(s.target.value),className:j,min:"0"})})}),e.jsx("div",{children:e.jsx(p,{label:"Total Unit SQM",description:"The sum of the area of all rentable units. This will be used for unit allocation.",children:e.jsx("input",{type:"number",step:"0.01",placeholder:"e.g., 1200.50",value:L,onChange:s=>ie(s.target.value),className:j})})})]}),D>0&&L>0&&e.jsxs("div",{className:`mt-6 p-4 rounded-lg text-sm ${w<0?"bg-red-50 text-red-800 border-red-200":"bg-gray-100 text-gray-800 border-gray-200"} border transition-colors`,children:[e.jsx("h5",{className:"font-bold mb-2",children:"Area Calculation"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{children:["Overall Property Area:"," ",e.jsxs("span",{className:"font-semibold",children:[Ne.toLocaleString()," sqm"]})]}),e.jsxs("p",{children:["- Total Unit Area:"," ",e.jsxs("span",{className:"font-semibold",children:[Se.toLocaleString()," sqm"]})]}),e.jsx("hr",{className:"my-1"}),e.jsxs("p",{className:`font-bold ${w<0?"text-red-600":""}`,children:["= Common/Unused Area:"," ",e.jsxs("span",{children:[w.toLocaleString()," sqm"]})]})]}),w<0&&e.jsx("p",{className:"mt-2 font-semibold",children:"Warning: The total unit area cannot be larger than the overall property area."})]})]}),n===2&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Location"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(p,{label:"Country*",children:e.jsx("input",{type:"text",value:"Philippines",className:j,disabled:!0,readOnly:!0})})}),e.jsx("div",{className:"relative",children:e.jsxs(p,{label:"Region*",children:[e.jsxs("select",{value:v,onChange:s=>ge(s.target.value),className:z,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a region..."}),de.map(s=>e.jsx("option",{value:s.region_code,children:s.region_name},s.region_code))]}),e.jsx(M,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(p,{label:"Province*",children:[e.jsxs("select",{value:b,onChange:s=>Z(s.target.value),className:z,disabled:!v,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a province..."}),me.map(s=>e.jsx("option",{value:s.province_code,children:s.province_name},s.province_code))]}),e.jsx(M,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(p,{label:"City / Municipality*",children:[e.jsxs("select",{value:_,onChange:s=>H(s.target.value),className:z,disabled:!b,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a city/municipality..."}),ue.map(s=>e.jsx("option",{value:s.city_code,children:s.city_name},s.city_code))]}),e.jsx(M,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(p,{label:"Barangay*",children:[e.jsxs("select",{value:J,onChange:s=>X(s.target.value),className:z,disabled:!_,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a barangay..."}),pe.map(s=>e.jsx("option",{value:s.brgy_code,children:s.brgy_name},s.brgy_code))]}),e.jsx(M,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx(p,{label:"Street Address",children:e.jsx("input",{type:"text",placeholder:"e.g., 123 Oak Avenue",value:oe,onChange:s=>ne(s.target.value),className:j})}),e.jsx(p,{label:"Zip / Postal Code",children:e.jsx("input",{type:"text",placeholder:"e.g., 1605",value:le,onChange:s=>ce(s.target.value),className:j})})]})]}),n===3&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Supporting Documents"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Add, remove, or update supporting documents for this property."}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(Fe,{label:"Business License(s)",files:A,setFiles:$e,description:xe,setDescription:ye}),e.jsx(Fe,{label:"Certificate(s) of Registration",files:O,setFiles:Ie,description:ve,setDescription:be})]})]})]}),(S||se)&&e.jsx("p",{className:"mt-4 text-sm font-medium text-red-600 bg-red-50 p-3 rounded-lg",children:S||se}),e.jsxs("div",{className:"flex justify-center gap-4 pt-6 mt-8 sm:justify-end sm:gap-3",children:[n>1&&e.jsx("button",{type:"button",onClick:Re,className:"flex-1 rounded-full border border-gray-300 bg-white px-8 py-3 text-sm font-medium text-gray-800 transition-colors hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:"Previous"}),n<R.length&&e.jsx("button",{type:"button",onClick:Ee,className:"flex-1 rounded-full bg-orange-600 px-8 py-3 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-orange-800 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:"Next"}),n===R.length&&e.jsx("button",{type:"submit",disabled:N,className:"flex-1 rounded-full bg-teal-600 px-8 py-3 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-teal-800 disabled:cursor-not-allowed disabled:bg-gray-300 disabled:text-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:N?"Saving Changes...":"Save Changes"})]})]})]})})})})]})})};export{ts as default};
