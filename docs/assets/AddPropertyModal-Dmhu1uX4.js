import{u as Ce,j as e,z as Pe,L as Fe,e as pe,q as Ue,f as Le,s as O}from"./index-ChuUIRBG.js";import{b as o}from"./vendor-C5zIUBfc.js";import{I as me,v as qe}from"./ImageUploader-piXC7qzV.js";import{I as De,F as C,a as Re}from"./index-DOEnYH1p.js";import{S as Ee}from"./Stepper-B5s6UTpD.js";import"./ui-DPhHsU_z.js";import"./react-paginate-dLrqzcou.js";const F=a=>Re.get(`https://isaacdarcilla.github.io/philippine-addresses/${a}.json`),$e=async()=>{try{return(await F("region")).data.map(i=>({id:i.id,psgc_code:i.psgc_code,region_name:i.region_name,region_code:i.region_code}))}catch(a){throw console.error("Error fetching regions:",a.message),a}},Ie=async a=>{try{return(await F("province")).data.filter(s=>s.region_code===a).map(s=>({psgc_code:s.psgc_code,province_name:s.province_name,province_code:s.province_code,region_code:s.region_code}))}catch(i){throw console.error("Error fetching provinces:",i.message),i}},Te=async a=>{try{return(await F("city")).data.filter(s=>s.province_code===a).map(s=>({city_name:s.city_name,city_code:s.city_code,province_code:s.province_code,region_desc:s.region_desc}))}catch(i){throw console.error("Error fetching cities:",i.message),i}},Be=async a=>{try{return(await F("barangay")).data.filter(s=>s.city_code===a).map(s=>({brgy_name:s.brgy_name,brgy_code:s.brgy_code,province_code:s.province_code,region_code:s.region_code}))}catch(i){throw console.error("Error fetching barangays:",i.message),i}},d=({label:a,children:i,description:s})=>e.jsxs("div",{children:[e.jsx("label",{className:"block mb-1.5 text-sm font-medium text-gray-700",children:a}),i,s&&e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:s})]}),f="block w-full text-sm rounded-lg border-gray-300 bg-gray-50 p-2.5 text-gray-900 focus:border-orange-500 focus:ring-orange-500 disabled:cursor-not-allowed disabled:opacity-60",P=`${f} appearance-none`,Oe=(a,i)=>{const s=a.lastIndexOf(".");return`${s===-1?a:a.substring(0,s)}.${i}`},Ae=(a,i={quality:.8})=>new Promise(s=>{const r=document.createElement("canvas");if(typeof r.toDataURL!="function"||r.toDataURL("image/avif").indexOf("data:image/avif")<0){console.warn("AVIF conversion not supported by this browser. Uploading original file."),s(a);return}const l=URL.createObjectURL(a),c=new Image;c.onload=()=>{r.width=c.width,r.height=c.height,r.getContext("2d").drawImage(c,0,0),r.toBlob(m=>{if(URL.revokeObjectURL(l),m&&m.type==="image/avif"){const u=Oe(a.name,"avif"),v=new File([m],u,{type:"image/avif"});console.log(`Converted ${a.name} (${(a.size/1024).toFixed(2)} KB) to ${v.name} (${(v.size/1024).toFixed(2)} KB)`),s(v)}else s(a)},"image/avif",i.quality)},c.onerror=()=>{URL.revokeObjectURL(l),console.error("Could not load image for conversion. Uploading original file."),s(a)},c.src=l}),ue=async(a,i)=>{if(!i)throw new Error("User ID is required for uploading files.");const s=[];for(const r of a)if(r.source==="new"&&r.file){let l=r.file;if(r.file.type.startsWith("image/"))try{l=await Ae(r.file)}catch(u){console.error("Image conversion failed, uploading original:",u),l=r.file}const c=`user_${i}/${qe()}-${l.name}`,{error:b}=await O.storage.from("property-documents").upload(c,l);if(b)throw console.error("Supabase upload error:",b),new Error(`Failed to upload ${l.name}.`);const{data:m}=O.storage.from("property-documents").getPublicUrl(c);if(!m?.publicUrl)throw new Error(`Could not get public URL for ${l.name}.`);s.push({url:m.publicUrl,path:c})}return s},w=["Property Details","Location","Documents"],We=({isOpen:a,onClose:i,onSuccess:s})=>{const[r,l]=o.useState(1),[c,b]=o.useState(!1),[m,u]=o.useState(""),[v,p]=o.useState(""),_=Ce(t=>t.userProfile),[U,A]=o.useState(""),[L,k]=o.useState(""),[N,M]=o.useState(""),[S,z]=o.useState(""),[Q,G]=o.useState(""),[K,V]=o.useState(""),[W,Z]=o.useState([]),[H,q]=o.useState([]),[Y,D]=o.useState([]),[J,R]=o.useState([]),[g,X]=o.useState(""),[h,E]=o.useState(""),[x,$]=o.useState(""),[I,T]=o.useState(""),[ee,te]=o.useState([]),[se,ae]=o.useState([]),[re,oe]=o.useState(""),[ie,ne]=o.useState(""),le=parseFloat(N||0),ce=parseFloat(S||0),j=le-ce;o.useEffect(()=>{(async()=>{try{const n=await $e();Z(n)}catch(n){console.error("Failed to load Philippine regions:",n),Z([])}})()},[]),o.useEffect(()=>{q([]),E(""),(async()=>{if(g)try{const n=await Ie(g);q(n)}catch(n){console.error(`Failed to load provinces for ${g}:`,n),q([])}})()},[g]),o.useEffect(()=>{D([]),$(""),(async()=>{if(h)try{const n=await Te(h);D(n)}catch(n){console.error(`Failed to load cities for ${h}:`,n),D([])}})()},[h]),o.useEffect(()=>{R([]),T(""),(async()=>{if(x)try{const n=await Be(x);R(n)}catch(n){console.error(`Failed to load barangays for ${x}:`,n),R([])}})()},[x]);const ge=()=>{A(""),k(""),M(""),z(""),G(""),V(""),X(""),E(""),$(""),T(""),te([]),ae([]),oe(""),ne(""),u(""),p(""),l(1)},B=()=>{ge(),i()},he=()=>{p("");let t=!0;r===1&&(U.trim()||(p("Property Name is a required field."),t=!1),j<0&&(p("Total Unit SQM cannot be greater than the Overall Property SQM."),t=!1)),r===2&&(g?h?x?I||(p("Barangay is a required field."),t=!1):(p("City / Municipality is a required field."),t=!1):(p("Province is a required field."),t=!1):(p("Region is a required field."),t=!1)),t&&r<w.length&&l(r+1)},xe=()=>{p(""),r>1&&l(r-1)},fe=async t=>{if(t.preventDefault(),r===w.length){if(j<0){u("Cannot save: Total Unit SQM exceeds Overall Property SQM.");return}if(!_?.id){u("You must be logged in to add a property.");return}b(!0),u(""),p("");try{const n=await ue(ee,_.id),ye=await ue(se,_.id),be={files:n,description:re.trim()},ve={files:ye,description:ie.trim()},je=W.find(y=>y.region_code===g)?.region_name,_e=H.find(y=>y.province_code===h)?.province_name,Ne=Y.find(y=>y.city_code===x)?.city_name,Se=J.find(y=>y.brgy_code===I)?.brgy_name,we={created_by:_.id,last_edited_by:_.id,property_name:U.trim(),number_of_units:L?parseInt(L,10):null,total_sqm:S?parseFloat(S):null,overall_sqm:N?parseFloat(N):null,address_country:"Philippines",address_country_iso:"PH",address_street:Q.trim(),address_zip_code:K.trim()||null,address_region:je||null,address_province:_e||null,address_city_municipality:Ne||null,address_barangay:Se||null,business_licenses:be,certificates_of_registration:ve},{error:de}=await O.from("properties").insert([we]);if(de)throw de;s(),B()}catch(n){console.error("Error adding property:",n),u(`Failed to add property: ${n.message}`)}finally{b(!1)}}};return e.jsx(Pe,{appear:!0,show:a,as:o.Fragment,children:e.jsxs(Fe,{as:"div",className:"relative z-50",onClose:B,children:[e.jsx(pe,{as:o.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm"})}),e.jsx("div",{className:"fixed inset-0 overflow-y-auto",children:e.jsx("div",{className:"flex min-h-full items-center justify-center p-2 sm:p-4",children:e.jsx(pe,{as:o.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:e.jsxs(Ue,{className:"w-full max-w-7xl transform overflow-hidden rounded-2xl bg-white p-6 text-left align-middle shadow-xl transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Le,{as:"h3",className:"text-2xl font-bold leading-6 text-gray-900",children:"Add New Property"}),e.jsx("button",{type:"button",onClick:B,className:"text-gray-400 hover:text-gray-600 transition-colors","aria-label":"Close",children:e.jsx(De,{className:"h-6 w-6"})})]}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Fill in the details below to register your property."}),e.jsx(Ee,{currentStep:r,steps:w}),e.jsxs("form",{onSubmit:fe,className:"mt-6",children:[e.jsxs("div",{className:"min-h-[350px]",children:[r===1&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Property Details"}),e.jsx("div",{className:"md:col-span-3",children:e.jsx(d,{label:"Property Name*",children:e.jsx("input",{type:"text",placeholder:"e.g., The Grand Residences",value:U,onChange:t=>A(t.target.value),className:f,required:!0})})}),e.jsx("div",{children:e.jsx(d,{label:"Overall Property SQM",description:"The total physical size of the property, including common areas like hallways.",children:e.jsx("input",{type:"number",step:"0.01",placeholder:"e.g., 1500",value:N,onChange:t=>M(t.target.value),className:f})})}),e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Units Details"}),e.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[e.jsx("div",{children:e.jsx(d,{label:"Number of Units",children:e.jsx("input",{type:"number",placeholder:"e.g., 50",value:L,onChange:t=>k(t.target.value),className:f,min:"0"})})}),e.jsx("div",{children:e.jsx(d,{label:"Total Unit SQM",description:"The sum of the area of all rentable units. This will be used for unit allocation.",children:e.jsx("input",{type:"number",step:"0.01",placeholder:"e.g., 1200.50",value:S,onChange:t=>z(t.target.value),className:f})})})]}),N>0&&S>0&&e.jsxs("div",{className:`mt-6 p-4 rounded-lg text-sm ${j<0?"bg-red-50 text-red-800 border-red-200":"bg-gray-100 text-gray-800 border-gray-200"} border transition-colors`,children:[e.jsx("h5",{className:"font-bold mb-2",children:"Area Calculation"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{children:["Overall Property Area:"," ",e.jsxs("span",{className:"font-semibold",children:[le.toLocaleString()," sqm"]})]}),e.jsxs("p",{children:["- Total Unit Area:"," ",e.jsxs("span",{className:"font-semibold",children:[ce.toLocaleString()," sqm"]})]}),e.jsx("hr",{className:"my-1"}),e.jsxs("p",{className:`font-bold ${j<0?"text-red-600":""}`,children:["= Common/Unused Area:"," ",e.jsxs("span",{children:[j.toLocaleString()," sqm"]})]})]}),j<0&&e.jsx("p",{className:"mt-2 font-semibold",children:"Warning: The total unit area cannot be larger than the overall property area."})]})]}),r===2&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Location"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsx(d,{label:"Country*",children:e.jsx("input",{type:"text",value:"Philippines",className:f,disabled:!0,readOnly:!0})})}),e.jsx("div",{className:"relative",children:e.jsxs(d,{label:"Region*",children:[e.jsxs("select",{value:g,onChange:t=>X(t.target.value),className:P,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a region..."}),W.map(t=>e.jsx("option",{value:t.region_code,children:t.region_name},t.region_code))]}),e.jsx(C,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(d,{label:"Province*",children:[e.jsxs("select",{value:h,onChange:t=>E(t.target.value),className:P,disabled:!g,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a province..."}),H.map(t=>e.jsx("option",{value:t.province_code,children:t.province_name},t.province_code))]}),e.jsx(C,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(d,{label:"City / Municipality*",children:[e.jsxs("select",{value:x,onChange:t=>$(t.target.value),className:P,disabled:!h,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a city/municipality..."}),Y.map(t=>e.jsx("option",{value:t.city_code,children:t.city_name},t.city_code))]}),e.jsx(C,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx("div",{className:"relative",children:e.jsxs(d,{label:"Barangay*",children:[e.jsxs("select",{value:I,onChange:t=>T(t.target.value),className:P,disabled:!x,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Select a barangay..."}),J.map(t=>e.jsx("option",{value:t.brgy_code,children:t.brgy_name},t.brgy_code))]}),e.jsx(C,{className:"pointer-events-none absolute right-3 top-[42px] h-5 w-5 text-gray-400"})]})}),e.jsx(d,{label:"Street Address",children:e.jsx("input",{type:"text",placeholder:"e.g., 123 Oak Avenue",value:Q,onChange:t=>G(t.target.value),className:f})}),e.jsx(d,{label:"Zip / Postal Code",children:e.jsx("input",{type:"text",placeholder:"e.g., 1605",value:K,onChange:t=>V(t.target.value),className:f})})]})]}),r===3&&e.jsxs("div",{className:"space-y-4 animate-fadeIn",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800 border-b pb-2",children:"Supporting Documents"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Uploading documents is optional but recommended for faster verification."}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(me,{label:"Business License(s)",files:ee,setFiles:te,description:re,setDescription:oe}),e.jsx(me,{label:"Certificate(s) of Registration",files:se,setFiles:ae,description:ie,setDescription:ne})]})]})]}),(m||v)&&e.jsx("p",{className:"mt-4 text-sm font-medium text-red-600 bg-red-50 p-3 rounded-lg",children:m||v}),e.jsxs("div",{className:"flex justify-center gap-4 pt-6 mt-8 sm:justify-end sm:gap-3",children:[r>1&&e.jsx("button",{type:"button",onClick:xe,className:"flex-1 rounded-full border border-gray-300 bg-white px-8 py-3 text-sm font-medium text-gray-800 transition-colors hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:"Previous"}),r<w.length&&e.jsx("button",{type:"button",onClick:he,className:"flex-1 rounded-full bg-orange-600 px-8 py-3 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-orange-800 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:"Next"}),r===w.length&&e.jsx("button",{type:"submit",disabled:c,className:"flex-1 rounded-full bg-teal-600 px-8 py-3 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-teal-800 disabled:cursor-not-allowed disabled:bg-gray-300 disabled:text-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 sm:flex-initial sm:rounded-md sm:px-6 sm:py-2",children:c?"Adding Property...":"Add Property"})]})]})]})})})})]})})};export{We as default};
