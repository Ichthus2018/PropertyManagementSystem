import{s as k,j as e,z as A,L as z,e as M,q as R,f as V}from"./index-VS4hTV8j.js";import{b as l}from"./vendor-C5zIUBfc.js";import{S as B}from"./Stepper-A_5wTI3i.js";import{c as x}from"./react-paginate-8Es1ox29.js";import{F as O}from"./Units-D3U2hofv.js";import{F as W}from"./BuildingOffice2Icon-D-1YPzJO.js";import"./ui-DPhHsU_z.js";import"./DataTable-D3-ZNYCt.js";import"./ImageUploader-C7sQW-vZ.js";import"./ExclamationTriangleIcon-DXl3jWQD.js";const f=async({table:m})=>{const{data:v,error:u}=await k.from(m).select("*");if(u)throw new Error(u.message);return v},P=()=>({id:null,property_name:"",number_of_units:0,total_sqm:0,units:[]});function Y(){const{data:m,isLoading:v}=x({table:"properties"},f),{data:u,isLoading:g}=x({table:"units"},f),{data:j}=x({table:"unit_types"},f),{data:p}=x({table:"leasing_types"},f),{data:S}=x({table:"unit_categories"},f),{data:C}=x({table:"unit_categories_2"},f),{data:F}=x({table:"unit_categories_3"},f),[b,c]=l.useState(null),[a,h]=l.useState(P()),[q,w]=l.useState(!1),[N,U]=l.useState(null),_=l.useMemo(()=>u?u.reduce((s,o)=>{const i=o.property_id;return s[i]||(s[i]={usedUnits:0,usedSqm:0}),s[i].usedUnits+=1,s[i].usedSqm+=Number(o.sqm||0),s},{}):{},[u]),n=l.useMemo(()=>m?m.map(s=>{const o=_[s.id]||{usedUnits:0,usedSqm:0},i=s.number_of_units-o.usedUnits,y=parseFloat((s.total_sqm-o.usedSqm).toFixed(2));return{...s,available_units:i,available_sqm:y}}).filter(s=>s.available_units>0):[],[m,_]),r=l.useMemo(()=>!b||!n?null:n.find(s=>s.id==b),[b,n]);l.useEffect(()=>{if(r){const s=r.available_units||0,o=[];for(let i=0;i<s;i++)o.push({id:`new_${Date.now()}_${i}`,name:`${r.property_name} Unit ${i+1}`,sqm:0,unit_type_id:"",leasing_type_id:"",unit_category_id:"",unit_category_2_id:"",unit_category_3_id:""});h({id:r.id,property_name:r.property_name,number_of_units:r.available_units,total_sqm:r.available_sqm,units:o})}else h(P())},[r]);const t=l.useMemo(()=>a.units.reduce((s,o)=>s+Number(o.sqm||0),0),[a.units]),D=l.useMemo(()=>Math.abs(a.total_sqm-t)<.01&&a.total_sqm>0,[a.total_sqm,t]),L=l.useMemo(()=>!!r,[r]),I=s=>{c(s.target.value)},$=(s,o)=>{const{name:i,value:y}=o.target,d=[...a.units];d[s]={...d[s],[i]:y},h(E=>({...E,units:d}))},T=()=>{c(null),h(P())};return{propertyData:a,selectedPropertyId:b,isSqmMatched:D,isStep1Valid:L,assignedSqm:t,isSaving:q,saveError:N,dropdownData:{properties:n,unitTypes:j||[],leasingTypes:p||[],unitCategories:S||[],unitCategories2:C||[],unitCategories3:F||[]},handlers:{handlePropertySelect:I,handleUnitChange:$,handleSave:async s=>{w(!0),U(null);try{const{data:{user:o}}=await k.auth.getUser();if(!o)throw new Error("You must be logged in to save units.");const i=a.units.map(d=>({name:d.name,sqm:d.sqm||0,property_id:a.id,user_id:o.id,unit_type_id:d.unit_type_id||null,leasing_type_id:d.leasing_type_id||null,unit_category_id:d.unit_category_id||null,unit_category_2_id:d.unit_category_2_id||null,unit_category_3_id:d.unit_category_3_id||null})),{error:y}=await k.from("units").insert(i);if(y)throw y;s&&s(),T()}catch(o){console.error("Failed to save units:",o),U(o.message||"An unexpected error occurred.")}finally{w(!1)}},resetState:T},isLoading:v||g}}function ae({isOpen:m,onClose:v,onSuccess:u}){const[g,j]=l.useState(1),{propertyData:p,selectedPropertyId:S,isSqmMatched:C,isStep1Valid:F,assignedSqm:b,dropdownData:c,handlers:a,isLoading:h,isSaving:q}=Y(),w=["Property Information","Unit Management"],N=()=>{j(1),a.resetState(),v()},U=()=>{console.log("Save successful!"),u&&u(),N()},_=c.properties.find(n=>n.id==S);return e.jsx(A,{appear:!0,show:m,as:l.Fragment,children:e.jsxs(z,{as:"div",className:"relative z-50 font-sans",onClose:N,children:[e.jsx(M,{as:l.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-neutral-900/50"})}),e.jsx("div",{className:"fixed inset-0 overflow-y-auto",children:e.jsx("div",{className:"flex min-h-full items-center justify-center xs:p-4 text-center",children:e.jsx(M,{as:l.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:e.jsxs(R,{className:"w-full max-w-4xl transform overflow-hidden rounded-2xl bg-white py-6  px-2 text-left align-middle shadow-2xl transition-all ring-1 ring-neutral-200",children:[e.jsxs(V,{as:"h3",className:"text-2xl font-semibold leading-6 text-neutral-900 flex justify-between items-start md:items-center pb-4 border-b border-neutral-200",children:[e.jsxs("div",{className:"flex-1",children:["Add Property:"," ",e.jsx("span",{className:"font-bold",children:p.property_name||"Select a Property"})]}),e.jsx("button",{onClick:N,className:"p-1 rounded-full text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-neutral-500",children:e.jsx(O,{className:"h-6 w-6"})})]}),e.jsx(B,{currentStep:g,steps:w}),h?e.jsx("div",{className:"text-center p-8 text-neutral-600",children:"Loading Available Properties..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-8",children:[g===1&&e.jsx("div",{className:"space-y-6 animate-fadeIn",children:e.jsxs("div",{className:"p-6 border border-neutral-200 rounded-lg bg-neutral-50",children:[e.jsx("h4",{className:"text-xl font-semibold text-neutral-800 mb-4",children:"Property Details"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"property_select",className:"block text-sm font-medium text-neutral-700 mb-1",children:"Select Property (Only properties with available space are shown)"}),e.jsxs("select",{id:"property_select",value:S||"",onChange:a.handlePropertySelect,className:"w-full px-4 py-2 border border-neutral-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors",children:[e.jsx("option",{value:"",disabled:!0,children:"-- Choose a property --"}),c.properties.map(n=>e.jsxs("option",{value:n.id,children:[n.property_name," (Sqm:"," ",n.available_sqm,", Units:"," ",n.available_units,")"]},n.id))]}),_&&e.jsxs("div",{className:"mt-4 p-4 bg-orange-50 rounded-md border border-orange-200 text-sm text-orange-800",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-bold",children:"Available Sqm for new units:"})," ",_.available_sqm]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-bold",children:"Available unit slots:"})," ",_.available_units]})]})]})})]})}),g===2&&e.jsx("div",{className:"animate-fadeIn",children:e.jsxs("div",{className:"p-6 border border-neutral-200 rounded-lg bg-neutral-50",children:[e.jsxs("div",{className:"flex flex-wrap justify-between items-baseline gap-4 mb-4 pb-2 border-b border-neutral-200",children:[e.jsxs("h4",{className:"text-xl font-semibold text-neutral-800",children:["Add ",p.number_of_units||0," New Units"]}),e.jsxs("div",{className:`font-bold text-base px-3 py-1 rounded-full ${C?"text-green-800 bg-green-100":"text-red-800 bg-red-100"}`,children:[b," / ",p.total_sqm||0," ","sqm assigned"]})]}),e.jsx("div",{className:"space-y-6 max-h-[55vh] overflow-y-auto pr-2 custom-scrollbar",children:p.units.map((n,r)=>e.jsxs("div",{className:"p-5 border border-neutral-200 rounded-lg shadow-sm bg-white/70 hover:bg-neutral-100 transition-colors duration-200",children:[e.jsxs("h5",{className:"font-bold text-lg text-neutral-800 mb-4 flex items-center",children:[e.jsx(W,{className:"h-5 w-5 mr-2 text-orange-600"}),"Unit ",r+1]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:"Unit Name"}),e.jsx("input",{type:"text",name:"name",value:n.name||"",onChange:t=>a.handleUnitChange(r,t),className:"w-full px-4 py-2 border border-neutral-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:"Sqm (Square Meters)"}),e.jsx("input",{type:"number",name:"sqm",value:n.sqm||0,onChange:t=>a.handleUnitChange(r,t),className:"w-full px-4 py-2 border border-neutral-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors",min:"0",max:p.total_sqm-b+(n.sqm||0),step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:"Unit Type"}),e.jsxs("select",{name:"unit_type_id",value:n.unit_type_id||"",onChange:t=>a.handleUnitChange(r,t),className:"w-full px-4 py-2 border border-neutral-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors",children:[e.jsx("option",{value:"",children:"-- Select --"}),c.unitTypes.map(t=>e.jsx("option",{value:t.id,children:t.unit_type},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:"Leasing Type"}),e.jsxs("select",{name:"leasing_type_id",value:n.leasing_type_id||"",onChange:t=>a.handleUnitChange(r,t),className:"w-full px-4 py-2 border border-neutral-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors",children:[e.jsx("option",{value:"",children:"-- Select --"}),c.leasingTypes.map(t=>e.jsx("option",{value:t.id,children:t.leasing_type},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:"Unit Category"}),e.jsxs("select",{name:"unit_category_id",value:n.unit_category_id||"",onChange:t=>a.handleUnitChange(r,t),className:"w-full px-4 py-2 border border-neutral-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors",children:[e.jsx("option",{value:"",children:"-- Select --"}),c.unitCategories.map(t=>e.jsx("option",{value:t.id,children:t.unit_category},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:"Category 2"}),e.jsxs("select",{name:"unit_category_2_id",value:n.unit_category_2_id||"",onChange:t=>a.handleUnitChange(r,t),className:"w-full px-4 py-2 border border-neutral-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors",children:[e.jsx("option",{value:"",children:"-- Select --"}),c.unitCategories2.map(t=>e.jsx("option",{value:t.id,children:t.unit_category_2},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-700 mb-1",children:"Category 3"}),e.jsxs("select",{name:"unit_category_3_id",value:n.unit_category_3_id||"",onChange:t=>a.handleUnitChange(r,t),className:"w-full px-4 py-2 border border-neutral-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors",children:[e.jsx("option",{value:"",children:"-- Select --"}),c.unitCategories3.map(t=>e.jsx("option",{value:t.id,children:t.unit_category_3},t.id))]})]})]})]},n.id||`new-unit-${r}`))})]})})]}),e.jsxs("div",{className:"mt-8 flex justify-between items-center",children:[e.jsx("div",{children:g>1&&e.jsx("button",{type:"button",onClick:()=>j(1),className:"px-6 py-2 text-sm font-medium text-neutral-700 bg-white border border-neutral-300 rounded-full shadow-sm hover:bg-neutral-100 transition-colors duration-200",children:"Back"})}),e.jsx("div",{className:"flex items-center space-x-3",children:g<w.length?e.jsx("button",{type:"button",onClick:()=>j(2),disabled:!F||h,className:"px-6 py-2 text-sm font-medium text-white bg-orange-600 rounded-full shadow-lg hover:bg-orange-700 disabled:bg-neutral-400 disabled:cursor-not-allowed transition-colors duration-200",children:"Next"}):e.jsx("button",{type:"button",onClick:()=>a.handleSave(U),disabled:!C||q,className:"px-6 py-2 text-sm font-medium text-white bg-orange-600 rounded-full shadow-lg hover:bg-orange-700 disabled:bg-neutral-400 disabled:cursor-not-allowed transition-colors duration-200",children:q?"Saving...":"Save Changes"})})]})]})]})})})})]})})}export{ae as default};
